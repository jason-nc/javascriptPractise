<!doctype html>
<html>   
   	<head>
		<title>AngularJs example</title>
      		<link href="../Bootstrap/css/bootstrap.min.css" rel="stylesheet">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script> 
		<script src="../Bootstrap/js/bootstrap.min.js"></script>
      		<script src = "https://ajax.googleapis.com/ajax/libs/angularjs/1.3.3/angular.min.js"></script>
      		<script src = "http://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular-route.min.js"></script>
      		<script src = "js/cookie.js"></script>
		<script type="text/javascript">
			var joker = jQuery.noConflict();
			var MarkitApp = angular.module("MarkitApp", ['ngRoute']);
			MarkitApp.config(['$routeProvider', function($routeProvider){
				$routeProvider.
					when('/getLookup', {
						templateUrl: 'getLookup.htm', 
						controller: 'markitLookupController'
					}).
					when('/getQuote', {
						templateUrl: 'getQuote.htm', 
						controller: 'markitGetQuoteController'
					}).
					when('/askForName', {
						templateUrl: 'askForName.htm',
						controller: 'markitGetNameController'
					}).
					otherwise({
						renterTo: '/askForName'
					});
			}]);
			MarkitApp.controller('markitLookupController', function($scope){
				$scope.lookup = {
					strSearchTerm: readCookie("lastLookup"),
					params: function(){ 
						return {
							"input" : $scope.lookup.strSearchTerm
						};
					},
					submitTicker: function(){
						ajaxMarkitQuote("http://dev.markitondemand.com/Api/v2/Lookup/jsonp", $scope.lookup.params(), $scope.lookup.successCallBack);
						createCookie("lastLookup",$scope.lookup.strSearchTerm,5);
					},
					successCallBack: function(data){
						joker("p").remove(".pLookup");
						joker("table").remove("#lookUpTable");
						var parsedData = JSON.parse(JSON.stringify(data));
						if(parsedData.Message != 'undefined'){
							var strResult = '<table id="lookUpTable"><tr><td>Symbol</td><td>Name</td><td>Exchange</td></tr>';
							joker.each(parsedData, function(key, value){
								strResult += "<tr><td>" + value.Symbol + "</td><td>" + value.Name + "</td><td>" + value.Exchange + "</td></tr>";
							});							
						}else{
							strResult += '<p class="pLookup">Message: ' + parsedData.Message + '</p>';
						}
						joker("#divLookup").append(strResult);
					}
				}
				$scope.messageLookup = "It worked.";
			});
			MarkitApp.controller('markitGetQuoteController', function($scope){
				$scope.getQuote = {
					strTickerSymbol: readCookie("lastTicker"),
					params: function(){ 
						return {
							"Symbol" : $scope.getQuote.strTickerSymbol
						};
					},		
					submitTicker: function(){
						ajaxMarkitQuote("http://dev.markitondemand.com/Api/v2/Quote/jsonp", $scope.getQuote.params(), $scope.getQuote.successCallBack);
						createCookie("lastTicker",$scope.getQuote.strTickerSymbol,5);
					},
					successCallBack: function(data){
						//alert(JSON.stringify(data));
						joker("p").remove(".pQuote");
						var parsedData = JSON.parse(JSON.stringify(data));
						var strResult = '<p class="pMarkit">Status: ' + parsedData.Status + '</p>';
						strResult += '<p class="pQuote">Name: ' + parsedData.Name + '</p>';
						strResult += '<p class="pQuote">Ticker: ' + parsedData.Symbol + '</p>';
						strResult += '<p class="pQuote">Last Price: ' + parsedData.LastPrice + '</p>';
						strResult += '<p class="pQuote">Change: ' + parsedData.Change + '</p>';
						strResult += '<p class="pQuote">Change Percent: ' + parsedData.ChangePercent + '</p>';
						strResult += '<p class="pQuote">Time Stamp: ' + parsedData.TimeStamp + '</p>';
						strResult += '<p class="pQuote">MS Date: ' + parsedData.MSDate + '</p>';
						strResult += '<p class="pQuote">Market Cap: ' + parsedData.MarketCap + '</p>';
						strResult += '<p class="pQuote">Volume: ' + parsedData.Volume + '</p>';
						strResult += '<p class="pQuote">Change YTD: ' + parsedData.ChangeYTD + '</p>';
						strResult += '<p class="pQuote">Change Percent YTD: ' + parsedData.ChangePercentYTD + '</p>';
						strResult += '<p class="pQuote">High: ' + parsedData.High + '</p>';
						strResult += '<p class="pQuote">Low: ' + parsedData.Low + '</p>';
						strResult += '<p class="pQuote">Open: ' + parsedData.Open + '</p>';
						joker("#divQuote").append(strResult);
					}
				}
				$scope.messageQuote = "It worked.";
			});
			MarkitApp.controller('markitGetNameController', function($scope){
				$scope.markit = {
					yourName: '',
	
					getName: function(){
						return $scope.markit.yourName;
					}
				}
			});
			
			function ajaxMarkitQuote(url, field, callback){
				var strResult = "";
				joker.ajax({
					url: url,
					method: "GET",
					data: field,
					dataType : "jsonp",
					error: function( jqXHR, textStatus, errorThrown){
						alert("failed");
						strResult = "Failed";
					},
					success: function(data, textStatus, jqXHR){
						callback(data);			
					}
				});			
			}
		</script>
		<style>
			body{
				max-width: 950px;
				margin: 0 auto 0 auto;
			}
		</style>
   	</head>   
	<body>
		<header>
			<nav class="navbar navbar-default" role="navigation">
				<div class="navbar-header">
      					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#example-navbar-collapse">
	         				<span class="sr-only">Toggle navigation</span>
         					<span class="icon-bar"></span>
         					<span class="icon-bar"></span>
         					<span class="icon-bar"></span>
      					</button>
      					<a class="navbar-brand" href="#">Bootstrap Home</a>
   				</div>
   				<div class="collapse navbar-collapse" id="example-navbar-collapse">
					<div>
						<ul class="nav navbar-nav">
							<li class="active"><a href="#askForName">Ask For Name</a></li>
							<li><a href="#getQuote">Get Quote</a></li>
							<li><a href="#getLookup">Lookup</a></li>
						</ul>
					</div>
				</div>
			</nav>
		</header>
      		<div ng-app="MarkitApp">
			<div class="ng-scope" ng-view=""></div>  
			<script type="text/ng-template" id="getLookup.htm">
				<h2>Look up</h2>
				<p><input type="text" ng-model="lookup.strSearchTerm" placeholder="Enter Ticker Symbol"/> - <button type="button" ng-click="lookup.submitTicker()">Submit Ticker</button></p>
				{{messageLookup}}
				<div id="divLookup"/>
			</script>
			<script type="text/ng-template" id="getQuote.htm">
				<h2>Quote</h2>
				<p><input type="text" ng-model="getQuote.strTickerSymbol" placeholder="Enter Ticker Symbol"/> - <button type="button" ng-click="getQuote.submitTicker()">Submit Ticker</button></p>
				{{messageQuote}}
				<div id="divQuote"/>
			</script>
			<script type="text/ng-template" id="askForName.htm">
         			<label>Name:</label>
         			<input type = "text" ng-model = "markit.yourName" placeholder = "Enter a name here">
         			<hr />         
         			<h1>Hello {{markit.getName()}}!</h1>
			</script>
      		</div>    
   	</body>
</html>